# データベースにおける MMAP

最近 Twitter で以下の論文の存在を知って、少し興味があったので、読んでみた[^1]。

[^1]: 論文のヘッダに "MMAP = :poop:" とかあって、既存技術をディスる系なのはちょっと好きではないけど。

- ["Are You Sure You Want to Use MMAP in Your Database Management System?"](https://cs.brown.edu/people/acrotty/pubs/p13-crotty.pdf)

結論は割とシンプルで「DBMS で mmap を使ってよいのはデータベースのサイズがメモリに収まっていて、かつリードオンリーな場合のみ [^2]」といったもので、大規模システムのメインのデータベースにおいては、実質使うべきでないと言っている。

[^2]: リードオンリーはキツすぎる気がする、これリードメイン、じゃないのかなと思うけど、実験は read の実験しかしていなくて分からない。

# 概要

mmap の特徴・課題について確認しておく。
2000 年代くらいに DBMS が mmap の利用を検討していたとき、従来の File I/O (read/write システムコール) に比べて mmap の利点として考えられていたのは、システムコールのオーバーヘッドを回避できるというのと、I/O の細かい制御を OS に任せることで DBMS をシンプルに実装できる、というのがあった。
しかし、多くのデータベースで mmap を用いた実装が試みられてきて、それを分析した結果、DBMS が mmap を使う際の問題点が整理されてきた。

- トランザクションの安全性: コミット処理の前後でデータの永続化のタイミングを制御しないといけない。
- I/O ストール: async I/O できない、全てのメモリアクセスにページフォルトの可能性があるため、遅延の予測や制御が難しい。
- エラーハンドリング
- 性能上の問題

このうち、3 つめまでは DBMS 側の実装を工夫すれば (結局実装が複雑になって mmap の利点が失われるようだが) ある程度は対処できるようだが、最後の性能問題は本質的で、回避が困難なようだ。
性能問題の要因もいくつかに分解して解説されている。

- ページ回収処理がシングルスレッド: 近年のストレージの高速化により顕在化した問題として、OS のページ回収アルゴリズムは数スレッドを越えてスケールしないというのがある。これは kswapd がシングルスレッドだから、というカーネル内の制約によるものらしい。
- ページテーブル同期: ページテーブルの同期処理が、同時実行するスレッドが大きな状況で競合が激しくなることも性能問題の原因として挙げられている。ただ、これについて詳細は論文内で説明されておらず、よく分からなかった。
- TLB shootdown: mmap を使用する上で TLB shootdown が問題となる。TLB shootdown 処理はページ回収の際に、他の CPU コアの TLB にある当該ページへのエントリを削除するという処理で、結構重い処理 (数千サイクル) であるため、パフォーマンスへの影響が大きい。

最初の二つはカーネルに手を加えることで対処可能としているが、TLB shootdown は mmap を使用している以上、回避が難しいらしい。

# 感想・疑問

mmap を使うということはメモリ管理の詳細をカーネルに任せるということなので、汎用的なメモリ管理で済む状況やリソースを富豪的に使える状況では有効、と言うのはまあ分かる。
アプリケーションが細かい最適なメモリ管理を求めるなら、自前で管理するのが筋という気はする。
DBMS 以外のアプリケーションやシステムプログラムなどにおいても、制約が緩い状況では mmap を使えばよいし、厳しい要件を課すなら自前できちんとやる必要がある。

カーネル側の状況も少しずつ変化していて、mmap のざっくりとした利点というのも見直す必要がある。
システムコールオーバーヘッドや I/O ストールの問題については File I/O の方で [io_uring](https://en.wikipedia.org/wiki/Io_uring) を使えるようになったことで、差別化要因にならなくなってくると思うし、
mmap では細かくメモリを制御できないという点については、ページキャッシュの使用状況をモニタリングする [DAMON](https://docs.kernel.org/mm/damon/index.html) とか、madvise の比較的新しめのフラグを使用してユーザ空間から明示的にページ回収を駆動したり書き出しだけ行えるとか、徐々に改善してきているように思う。
ただ、mmap の難点として論文内で指摘されていた、IO スケジューリングの制御ができないという点はまだ解決されていないのかなという気がする (詳しく知らない）。

メモリ管理・制御の発展によってデータベース側で必要とされる機能を提供できるようになってこれば、また mmap の利用価値が見直されてくるのではないかとも思うが、コミュニティ間の連携や新機能の登場が必要な気がしていて、長期的な話になりそうに思う。
そういう活動は存在していて、昔 LSFMM サミットで DB 関係の開発者を招いてディスカッションしたことがあったはずだが、あれがどういう形で開発に反映されたのかは追っていないので分からない。

論文への感想としては、実験があっさりしすぎで、これで課題を全て浮き彫りにして議論したとは言えない気がする。
また、ページテーブル同期の競合とか、あまり議論・実験されていない点もあって、もう少しボリュームが欲しいかなと思った。
実験結果から mmap の性能低下の原因が TLB shootdown であることが示せていないように思う。

この論文内で引用された文献の著者が、反論 (というかコメント) しているブログがあった。
https://ravendb.net/articles/re-are-you-sure-you-want-to-use-mmap-in-your-database-management-system 

後で読んでみるかな...。

<!--
thp が例外なくオフられる問題はこの話の一部としてあり、個人的に何が満たされれば DBMS のようなアプリケーションがうまくカーネルの機能を使えるのか、というのは知っておきたい気がする。

mmap は非効率だ、それは分かった。
個人的に気になるのは hugetlbfs を用いるデータベースである。
これらはバッキングストアがない (swap out もしない) ため、メモリ回収を前提としない用途で用いる前提である。
なので、データベースが hugetlbfs を用いる場合、どういう使い方をするのかというと、
メモリサイズを意識して従来どおりデータベース側でデータの書き出し、削除をコントロールしないといけないということになる。
おそらく通常のメモリの使い方とは異なる使い方をしているところに hugetlbfs を用いているという使い方にならざるを得ないのだろう。
-->
