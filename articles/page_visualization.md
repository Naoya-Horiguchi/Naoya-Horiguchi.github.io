# ページの可視化

[page-types.c](https://github.com/torvalds/linux/blob/master/tools/vm/page-types.c) というツールがあります。これはカーネルが管理するページ構造体の情報のうち、ユーザ空間に公開されている情報を取り出して、表示するツールです。カーネル開発者以外にはあまり用のないツールかもしれませんが、本記事ではこれを用いたページの可視化について紹介します。

`page-types` は引数を与えずに実行した場合、以下のようにシステム全体のページフラグ別の統計情報が表示されます。

~~~
~$ sudo page-types
             flags      page-count       MB  symbolic-flags                     long-symbolic-flags
0x0000000000000000           19759       77  ____________________________________________
0x0000000000028000               2        0  _______________H_G__________________________       compound_head,huge
0x0000000000030000            1022        3  ________________TG__________________________       compound_tail,huge
0x0000000004000000             990        3  __________________________g_________________       pgtable
0x0000000001000000               1        0  ________________________z___________________       zero_page
0x0000000000000020             375        1  _____l______________________________________       lru
0x0000000000000024             159        0  __R__l______________________________________       referenced,lru
0x0000000000000028            2631       10  ___U_l______________________________________       uptodate,lru
0x0000000000006028               1        0  ___U_l_______sb_____________________________       uptodate,lru,swapcache,swapbacked
0x000000000000002c            1378        5  __RU_l______________________________________       referenced,uptodate,lru
0x0000000000000038               4        0  ___UDl______________________________________       uptodate,dirty,lru
0x000000000000403c               5        0  __RUDl________b_____________________________       referenced,uptodate,dirty,lru,swapbacked
0x000000000000003c               3        0  __RUDl______________________________________       referenced,uptodate,dirty,lru
0x0000000000000060            2138        8  _____lA_____________________________________       lru,active
0x0000000000000064             394        1  __R__lA_____________________________________       referenced,lru,active
0x0000000000000068             573        2  ___U_lA_____________________________________       uptodate,lru,active
0x000000000000006c            4915       19  __RU_lA_____________________________________       referenced,uptodate,lru,active
0x0000000000000074              14        0  __R_DlA_____________________________________       referenced,dirty,lru,active
0x0000000000000078               1        0  ___UDlA_____________________________________       uptodate,dirty,lru,active
0x000000000000407c               3        0  __RUDlA_______b_____________________________       referenced,uptodate,dirty,lru,active,swapbacked
0x000000000000007c               1        0  __RUDlA_____________________________________       referenced,uptodate,dirty,lru,active
0x0000000000000080           19709       76  _______S____________________________________       slab
0x0000000000000228             292        1  ___U_l___I__________________________________       uptodate,lru,reclaim
0x0000000000006228              63        0  ___U_l___I___sb_____________________________       uptodate,lru,reclaim,swapcache,swapbacked
0x0000000000004238               2        0  ___UDl___I____b_____________________________       uptodate,dirty,lru,reclaim,swapbacked
0x0000000000000268              26        0  ___U_lA__I__________________________________       uptodate,lru,active,reclaim
0x000000000000427c               1        0  __RUDlA__I____b_____________________________       referenced,uptodate,dirty,lru,active,reclaim,swapbacked
0x0000000000000400           25081       97  __________B_________________________________       buddy
0x0000000000000800               2        0  ___________M________________________________       mmap
0x0000000000000828           10147       39  ___U_l_____M________________________________       uptodate,lru,mmap
0x000000000000082c            3636       14  __RU_l_____M________________________________       referenced,uptodate,lru,mmap
0x000000000004082c            2049        8  __RU_l_____M______u_________________________       referenced,uptodate,lru,mmap,unevictable
0x0000000000000838              89        0  ___UDl_____M________________________________       uptodate,dirty,lru,mmap
0x0000000000004838               1        0  ___UDl_____M__b_____________________________       uptodate,dirty,lru,mmap,swapbacked
0x000000000000083c              38        0  __RUDl_____M________________________________       referenced,uptodate,dirty,lru,mmap
0x0000000000000868             963        3  ___U_lA____M________________________________       uptodate,lru,active,mmap
0x000000000000086c            4594       17  __RU_lA____M________________________________       referenced,uptodate,lru,active,mmap
0x0000000000000878              14        0  ___UDlA____M________________________________       uptodate,dirty,lru,active,mmap
0x000000000000087c              36        0  __RUDlA____M________________________________       referenced,uptodate,dirty,lru,active,mmap
0x0000000000007028              20        0  ___U_l______asb_____________________________       uptodate,lru,anonymous,swapcache,swapbacked
0x0000000000005048              10        0  ___U__A_____a_b_____________________________       uptodate,active,anonymous,swapbacked
0x0000000000007068             152        0  ___U_lA_____asb_____________________________       uptodate,lru,active,anonymous,swapcache,swapbacked
0x0000000000007828             342        1  ___U_l_____Masb_____________________________       uptodate,lru,mmap,anonymous,swapcache,swapbacked
0x0000000000005828              35        0  ___U_l_____Ma_b_____________________________       uptodate,lru,mmap,anonymous,swapbacked
0x000000000004582c            2535        9  __RU_l_____Ma_b___u_________________________       referenced,uptodate,lru,mmap,anonymous,swapbacked,unevictable
0x0000000000005838             823        3  ___UDl_____Ma_b_____________________________       uptodate,dirty,lru,mmap,anonymous,swapbacked
0x000000000000583c               2        0  __RUDl_____Ma_b_____________________________       referenced,uptodate,dirty,lru,mmap,anonymous,swapbacked
0x0000000000005848               7        0  ___U__A____Ma_b_____________________________       uptodate,active,mmap,anonymous,swapbacked
0x0000000000007868             175        0  ___U_lA____Masb_____________________________       uptodate,lru,active,mmap,anonymous,swapcache,swapbacked
0x0000000000005868          156404      610  ___U_lA____Ma_b_____________________________       uptodate,lru,active,mmap,anonymous,swapbacked
0x000000000000586c              14        0  __RU_lA____Ma_b_____________________________       referenced,uptodate,lru,active,mmap,anonymous,swapbacked
0x0000000000005878             491        1  ___UDlA____Ma_b_____________________________       uptodate,dirty,lru,active,mmap,anonymous,swapbacked
0x000000000000587c              16        0  __RUDlA____Ma_b_____________________________       referenced,uptodate,dirty,lru,active,mmap,anonymous,swapbacked
             total          262138     1023
~~~

物理アドレスを意識して情報を表示したい場合、以下のように `-l` オプションで表示できます。`-N` オプションをしたいした場合、統計情報が表示されません。

~~~
~$ sudo page-types -Nl | head -n30
offset  len     flags
0       1       ___________M________________________________
1       f       ____________________________________________
10      2       __________B_________________________________
12      1       _______S____________________________________
13      6d      __________B_________________________________
80      1       ____________________________________________
81      f       __________B_________________________________
90      2       _______S____________________________________
92      4       __________B_________________________________
96      1       ____________________________________________
97      2       __________B_________________________________
99      67      ____________________________________________
100     40      __________B_________________________________
140     4       _______S____________________________________
144     c       __________B_________________________________
150     8       _______S____________________________________
158     6       __________B_________________________________
15e     1       ____________________________________________
15f     1       __________B_________________________________
160     8       _______S____________________________________
168     d2      __________B_________________________________
23a     2       __RU_lA____M________________________________
23c     1c4     __________B_________________________________
400     1       _______________H_G__________________________
401     1ff     ________________TG__________________________
600     14      __________B_________________________________
614     1       __RU_lA____M________________________________
615     17      __________B_________________________________
62c     2       __RU_lA____M________________________________
~~~

上記は「物理アドレスのここからここまでがこの状態である」という情報をすべて含むため、これを適当に加工して画像ファイルを生成することで、今回のような可視化ができます。

意味のある可視化のためには、フラグを選択する必要があります。例えば "referenced" フラグや "uptodate" フラグはそれ単独で場所が特定できてもあまり嬉しいことはないため、これらは無視してそれ以外のフラグが同じページと同じ状態とみなします。

# 小さなインスタンスの物理メモリの可視化

メモリサイズ 1GB のインスタンス上で、ページ状態から画像を生成したところ、以下のようになりました。

![](/images/data.5.0xc5234a0.png)

左上から右に各ページフレーム番号に対応するピクセルを並べ、512 ページごとに改行しています。イメージ的には下記のようになります。

<table>
<tr><td>0</td><td>1</td><td>2</td><td>..</td><td>511</td></tr>
<tr><td>512</td><td>513</td><td>514</td><td>..</td><td>1024</td></tr>
<tr><td colspan=5>...</td></tr>
</table>

メモリサイズが 1GB の場合、ページは全部で 256k 程度になるため、512x512 の画像として表現できます。図の右側に凡例としてどのページ状態が何色かを示しておきました (薄い色は読みづらく、すみません)。上の図は、システム起動後しばらく起動しておいた後に、特に負荷のかかる処理はしていない時点のページ状態に基づいて生成したものです。大多数は空きメモリ (buddy) ですが、別状態のページが細かく入り組んでいて霜降り肉のようになっているのがわかります。巷でよく言われているように、これはメモリフラグメンテーションが進んだ状態です。

次の図は、この状態から `sysctl vm.nr_hugepages=100` で hugepage の確保を試み、さらに 700MB のメモリを割り当てるプロセスを起動した状態での可視化です。

![](/images/data.6.0xc5234a0.png)

多くのページが anonymous ページとして割り当てられていますが、hugepage は 2 つ (1024 ページ分) しか確保できておらず、thp も割り当てられていないことがわかります。

次にいったんシステムを再起動して、再起動直後のページ状態を可視化してみます。

![](/images/data.7.0xc5234a0.png)

3~4 割のメモリが起動時の処理により使用された形跡が伺えます。buddy は赤い部分が連続領域として残されていて、まだフラグメントしていないことがわかります。

この状態から、hugepage や thp を割り当ててみると、以下のようにちゃんと 2MB ページ (512 ページなので横一行分に相当) が確保されているのがわかります。

![](/images/data.8.0xc5234a0.png)

# まとめ

現状、この可視化によってなにか新しい知見が得られたわけではありませんが、NUMA 環境でどうなるか、特定の処理 (ベンチマーク、カーネルビルドなど) を実行中の時間発展を追う、など面白そう (良い画が撮れそう) なのでやってみようかと思います。
